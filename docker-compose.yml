version: '3.4'

services:
  # OrderApi:
  #   image: ${DOCKER_REGISTRY-}order-api
  #   build:
  #     context: .
  #     dockerfile: src/Services/Order/Api/Dockerfile
  #   container_name: order-api
  #   depends_on:
  #     - OrderDb

  # InventoryApi:
  #   image: ${DOCKER_REGISTRY-}inventory-api
  #   build:
  #     context: .
  #     dockerfile: src/Services/Inventory/Api/Dockerfile
  #   container_name: inventory-api
  #   depends_on:
  #     - InventoryDb

  # PaymentApi:
  #   image: ${DOCKER_REGISTRY-}payment-api
  #   build:
  #     context: .
  #     dockerfile: src/Services/Payment/Api/Dockerfile
  #   container_name: payment-api
  #   depends_on:
  #     - PaymentDb

  UserApi:
    image: ${DOCKER_REGISTRY-}user-api
    build:
      context: .
      dockerfile: src/Services/User/Api/Dockerfile
    container_name: user-api
    depends_on:
      - UserDb
      - RabbitMqBroker

  RabbitMqBroker:
    image: rabbitmq:3-management-alpine
    container_name: 'rabbitmq'

  # OrderDb:
  #   image: postgres
  #   container_name: order-db

  # InventoryDb:
  #   image: postgres
  #   container_name: inventory-db

  # PaymentDb:
  #   image: postgres
  #   container_name: payment-db

  UserDb:
    # image: postgres
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: user-db
    # restart: always
    command: /bin/bash /scripts/docker-entrypoint.sh
    volumes:
     - ./src/Services/User/CreateDatabase:/scripts/
    # command:
    #   - /bin/bash
    #   - -c 
    #   - |
    #     # Launch MSSQL and send to background
    #     /opt/mssql/bin/sqlservr &
    #     # Wait 30 seconds for it to be available
    #     # (lame, I know, but there's no nc available to start prodding network ports)
    #     sleep 30
    #     # Run every script in /scripts
    #     # TODO set a flag so that this is only done once on creation, 
    #     #      and not every time the container runs
    #     for foo in /scripts/*.sql
    #       do /opt/mssql-tools/bin/sqlcmd -U sa -P Password1234! -l 30 -e -i $$foo
    #     done
    #     # So that the container doesn't shut down, sleep this thread
    #     sleep infinity
  